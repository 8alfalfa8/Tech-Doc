# Spring Bootオンライン処理スケルトン設計書 (AP基盤)

## 1. 設計方針
- 共通機能をベースクラスとして実装し、業務毎の機能はこれを継承して実装する
- 依存性注入(DI)を活用した疎結合な設計
- レイヤードアーキテクチャを採用
- RESTful APIを基本とする

## 2. プロジェクト構成

```
src/main/java/com/example/apbase/
├── common/               # 共通機能パッケージ
│   ├── config/           # 設定関連
│   ├── exception/        # 例外処理
│   ├── filter/           # フィルター
│   ├── interceptor/      # インターセプター
│   ├── logging/          # ロギング
│   ├── model/            # 共通モデル
│   ├── util/             # ユーティリティ
│   └── validation/       # バリデーション
├── controller/           # コントローラーベース
├── service/              # サービスベース
├── repository/           # リポジトリベース
└── entity/               # エンティティベース
```

## 3. 共通ベースクラス設計

### 3.1 ベースコントローラー (`BaseController`)

```java
package com.example.apbase.controller;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

public abstract class BaseController<T, ID> {

    /**
     * エンティティ作成
     * @param entity 作成対象エンティティ
     * @return 作成済みエンティティ
     */
    @PostMapping
    public abstract ResponseEntity<T> create(@RequestBody T entity);

    /**
     * エンティティ取得
     * @param id エンティティID
     * @return 取得したエンティティ
     */
    @GetMapping("/{id}")
    public abstract ResponseEntity<T> read(@PathVariable ID id);

    /**
     * エンティティ更新
     * @param id 更新対象エンティティID
     * @param entity 更新内容
     * @return 更新済みエンティティ
     */
    @PutMapping("/{id}")
    public abstract ResponseEntity<T> update(@PathVariable ID id, @RequestBody T entity);

    /**
     * エンティティ削除
     * @param id 削除対象エンティティID
     * @return 処理結果
     */
    @DeleteMapping("/{id}")
    public abstract ResponseEntity<Void> delete(@PathVariable ID id);
}
```

### 3.2 ベースサービス (`BaseService`)

```java
package com.example.apbase.service;

import java.util.List;

public interface BaseService<T, ID> {
    T create(T entity);
    T findById(ID id);
    List<T> findAll();
    T update(ID id, T entity);
    void delete(ID id);
}
```

### 3.3 ベースリポジトリ (`BaseRepository`)

```java
package com.example.apbase.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.repository.NoRepositoryBean;

@NoRepositoryBean
public interface BaseRepository<T, ID> extends JpaRepository<T, ID> {
    // 共通のカスタムメソッドを追加可能
}
```

## 4. 共通機能実装

### 4.1 グローバル例外ハンドラ

```java
package com.example.apbase.common.exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleException(Exception e) {
        ErrorResponse response = new ErrorResponse(
            HttpStatus.INTERNAL_SERVER_ERROR.value(),
            "Internal Server Error",
            e.getMessage()
        );
        return new ResponseEntity<>(response, HttpStatus.INTERNAL_SERVER_ERROR);
    }

    // その他の例外ハンドラを追加
}
```

### 4.2 ロギング設定

```java
package com.example.apbase.common.logging;

import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

@Aspect
@Component
public class LoggingAspect {

    private final Logger logger = LoggerFactory.getLogger(this.getClass());

    @Before("execution(* com.example.apbase..*.*(..))")
    public void logBefore(JoinPoint joinPoint) {
        logger.info("Executing: {}", joinPoint.getSignature().toShortString());
    }
}
```

## 5. 業務機能実装例 (ユーザー管理)

### 5.1 ユーザーコントローラー

```java
package com.example.apbase.user.controller;

import com.example.apbase.controller.BaseController;
import com.example.apbase.user.model.User;
import com.example.apbase.user.service.UserService;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/users")
public class UserController extends BaseController<User, Long> {

    private final UserService userService;

    public UserController(UserService userService) {
        this.userService = userService;
    }

    @Override
    public ResponseEntity<User> create(@RequestBody User user) {
        User createdUser = userService.create(user);
        return ResponseEntity.ok(createdUser);
    }

    @Override
    public ResponseEntity<User> read(@PathVariable Long id) {
        User user = userService.findById(id);
        return ResponseEntity.ok(user);
    }

    // その他のメソッドも同様に実装
}
```

### 5.2 ユーザーサービス

```java
package com.example.apbase.user.service;

import com.example.apbase.service.BaseService;
import com.example.apbase.user.model.User;

public interface UserService extends BaseService<User, Long> {
    // ユーザー固有のメソッドを追加可能
    User findByUsername(String username);
}
```

## 6. 設定クラス

### 6.1 Web設定

```java
package com.example.apbase.common.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // 共通インターセプターを登録
    }
}
```

### 6.2 データベース設定

```java
package com.example.apbase.common.config;

import org.springframework.boot.autoconfigure.domain.EntityScan;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;

@Configuration
@EntityScan("com.example.apbase.entity")
@EnableJpaRepositories("com.example.apbase.repository")
public class DatabaseConfig {
}
```

## 7. 適用技術スタック

- Spring Boot 3.x
- Spring Data JPA
- Hibernate
- Lombok (ボイラープレートコード削減)
- MapStruct (DTOマッピング)
- Spring Validation
- Spring Security (認証/認可)
- Swagger/OpenAPI (APIドキュメント)

このスケルトン設計をベースに、各業務機能を実装していくことで、一貫性のある保守性の高いアプリケーションを構築できます。共通機能はベースクラスに実装し、業務固有の機能は継承したクラスで実装するようにすることで、コードの重複を防ぎ、開発効率を向上させることができます。

---

# SpringBootオンライン処理スケルトン設計書 (AP基盤)

## 1. 設計方針
- 共通機能をベースクラスとして実装し、業務機能はこれを継承して実装
- 画面表示はJSPを使用
- 3層アーキテクチャを採用 (Controller - Service - Repository)
- 共通処理はAOPで実装

## 2. プロジェクト構成

```
src/main/java/
├── com.example.apbase
│   ├── config/          # 設定クラス
│   ├── controller/      # コントローラ層
│   │   ├── base/        # 基底コントローラ
│   ├── service/         # サービス層
│   │   ├── base/        # 基底サービス
│   ├── repository/      # リポジトリ層
│   ├── model/           # モデルクラス
│   │   ├── entity/      # エンティティ
│   │   ├── dto/         # DTO
│   │   ├── form/        # フォーム
│   ├── exception/       # 例外処理
│   ├── aspect/          # AOP処理
│   ├── util/            # ユーティリティ
│   └── ApBaseApplication.java # 起動クラス
src/main/resources/
├── static/              # 静的リソース
├── templates/           # JSPファイル
│   ├── common/          # 共通JSP
│   ├── layout/          # レイアウト
└── application.yml      # 設定ファイル
```

## 3. 基底コントローラ設計

### 3.1 BaseController.java
```java
package com.example.apbase.controller.base;

import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ModelAttribute;

public abstract class BaseController {
    
    /**
     * 初期表示処理
     * @param model Modelオブジェクト
     * @return 画面パス
     */
    public abstract String init(Model model);
    
    /**
     * 入力チェック
     * @param form 入力フォーム
     * @return エラー有無
     */
    protected boolean validate(Object form) {
        // 共通バリデーションを実装
        return true;
    }
    
    /**
     * モデルに共通項目を設定
     */
    @ModelAttribute
    public void setCommonAttributes(Model model) {
        model.addAttribute("systemName", "AP基盤システム");
        // その他共通項目
    }
}
```

## 4. 業務コントローラ実装例

### 4.1 SampleController.java
```java
package com.example.apbase.controller;

import com.example.apbase.controller.base.BaseController;
import com.example.apbase.model.form.SampleForm;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;

@Controller
@RequestMapping("/sample")
public class SampleController extends BaseController {
    
    @Override
    @GetMapping
    public String init(Model model) {
        // 初期データ設定
        model.addAttribute("sampleForm", new SampleForm());
        return "sample/index";
    }
    
    @PostMapping("/confirm")
    public String confirm(SampleForm form, Model model) {
        if (!validate(form)) {
            return "sample/index";
        }
        // 確認処理
        return "sample/confirm";
    }
    
    @PostMapping("/complete")
    public String complete(SampleForm form, Model model) {
        // 登録処理
        return "sample/complete";
    }
}
```

## 5. 基底サービス設計

### 5.1 BaseService.java
```java
package com.example.apbase.service.base;

import org.springframework.transaction.annotation.Transactional;

import java.util.List;

public interface BaseService<T, ID> {
    
    @Transactional(readOnly = true)
    List<T> findAll();
    
    @Transactional(readOnly = true)
    T findById(ID id);
    
    @Transactional
    T save(T entity);
    
    @Transactional
    void delete(ID id);
}
```

### 5.2 BaseServiceImpl.java
```java
package com.example.apbase.service.base;

import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public abstract class BaseServiceImpl<T, ID, R extends JpaRepository<T, ID>> 
        implements BaseService<T, ID> {
    
    protected final R repository;
    
    protected BaseServiceImpl(R repository) {
        this.repository = repository;
    }
    
    @Override
    public List<T> findAll() {
        return repository.findAll();
    }
    
    @Override
    public T findById(ID id) {
        return repository.findById(id).orElse(null);
    }
    
    @Override
    public T save(T entity) {
        return repository.save(entity);
    }
    
    @Override
    public void delete(ID id) {
        repository.deleteById(id);
    }
}
```

## 6. 共通例外処理

### 6.1 GlobalExceptionHandler.java
```java
package com.example.apbase.exception;

import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;

@ControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(Exception.class)
    public String handleException(Exception e, Model model) {
        model.addAttribute("errorMessage", "システムエラーが発生しました");
        // ログ出力
        return "error/system";
    }
    
    // その他の例外ハンドラ
}
```

## 7. 共通AOP処理

### 7.1 LoggingAspect.java
```java
package com.example.apbase.aspect;

import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.annotation.AfterReturning;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.springframework.stereotype.Component;

@Aspect
@Component
public class LoggingAspect {
    
    @Before("execution(* com.example.apbase.controller..*.*(..))")
    public void beforeController(JoinPoint joinPoint) {
        // コントローラ処理前のログ
    }
    
    @AfterReturning(pointcut = "execution(* com.example.apbase.service..*.*(..))", returning = "result")
    public void afterService(JoinPoint joinPoint, Object result) {
        // サービス処理後のログ
    }
}
```

## 8. JSP共通レイアウト

### 8.1 layout.jsp
```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title><c:out value="${systemName}"/> - <c:out value="${pageTitle}"/></title>
    <link rel="stylesheet" href="/css/common.css">
</head>
<body>
    <header>
        <!-- 共通ヘッダー -->
    </header>
    
    <main>
        <jsp:include page="${contentPage}"/>
    </main>
    
    <footer>
        <!-- 共通フッター -->
    </footer>
</body>
</html>
```

## 9. 設定クラス

### 9.1 WebMvcConfig.java
```java
package com.example.apbase.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.ViewResolverRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    
    @Override
    public void configureViewResolvers(ViewResolverRegistry registry) {
        registry.jsp("/WEB-INF/views/", ".jsp");
    }
}
```

## 10. 実装ガイドライン

1. 新しい業務機能を実装する場合:
   - コントローラはBaseControllerを継承
   - サービスはBaseService/BaseServiceImplを継承
   - JSPは共通レイアウトを利用

2. 共通処理を追加する場合:
   - 基底クラスまたはAOPに実装
   - 全業務で利用できるように設計

3. 例外処理:
   - 業務固有例外は独自例外として定義
   - 共通例外ハンドラで処理

4. トランザクション管理:
   - サービス層で@Transactionalを付与
   - 読み取り専用メソッドにはreadOnly=trueを設定

このスケルトン設計を基に、各業務機能を実装していくことで、一貫性のあるアプリケーション開発が可能になります。
