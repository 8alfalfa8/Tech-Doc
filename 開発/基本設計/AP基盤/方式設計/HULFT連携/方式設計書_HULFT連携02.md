#  方式設計書　HULFT連携処理

本基本設計書は、HULFT（ファイル転送ミドルウェア）を用いて外部システム／パートナーとのデータ連携を行うための設計方針、構成、運用手順、テスト観点を定めることを目的とする。

---

## 版管理

| バージョン |         日付 | 作成者  | 変更点 |
| ----: | ---------: | ---- | --- |
|   0.1 | YYYY-MM-DD | 作成者名 | 初版  |

---

# 1. 目的

本書は、HULFTを用いたバッチ／オンライン連携処理の基本設計を示す。対象システム間でのファイル受渡し、転送管理（監視・リトライ）、セキュリティ要件、運用手順およびテスト観点を定義し、開発・運用担当者が実装・運用できるレベルの設計基盤を提供する。

# 2. 適用範囲

* 対象システム：システムA（送信側）、システムB（受信側）
* 対象データ：注文データCSV、応答データXML など
* 対象プロトコル／ミドルウェア：HULFT X（バージョン：X.Y）
* 対象方式：ファイルベース（プッシュ／ポーリング）

# 3. 前提条件

* HULFTが各拠点にインストール・ライセンス済みであること
* 転送経路（TCP/IP）、必要なポートがFWで許可されていること
* 送受信双方でのファイル仕様（フォーマット、文字コード、改行コード）が確定していること
* 監視・ログ基盤（Syslog/ELK等）やジョブ管理ツールと連携する要否が合意済みであること

# 4. 用語定義

* HULFT：株式会社日立製作所提供のファイル転送ミドルウェア
* 送信側／受信側：ファイルを送る/受け取るシステム
* JT（Job Template）：HULFTの転送定義ファイル

# 5. 全体アーキテクチャ（概要）

> ※ここに簡易アーキテクチャ図を挿入（図は別添）

システムA（生成） → HULFT送信 → ネットワーク → HULFT受信 → システムB（取込）

* 各ノードにおける監視ポイント：転送ログ、転送状態、ファイル整合性チェック、受信後の登録結果

# 6. データ設計

## 6.1 ファイル一覧

| No | ファイル名（例）                  | 方向  | 形式  | 文字コード | 備考           |
| -: | ------------------------- | --- | --- | ----- | ------------ |
|  1 | ORD\_YYYYMMDD\_HHMMSS.csv | A→B | CSV | UTF-8 | 注文データ（ヘッダあり） |
|  2 | RSP\_YYYYMMDD\_HHMMSS.xml | B→A | XML | UTF-8 | 処理結果応答       |

## 6.2 ファイル命名規則

`<業務>_<YYYYMMDD>_<HHMMSS>.<拡張子>`

* 例：`ORD_20250809_153000.csv`
* 送信元IDや連番が必要な場合は末尾に付与：`ORD_20250809_153000_SRC01_0001.csv`

## 6.3 レコード定義（サンプル）

### 注文CSV（ORD）

| 項目          |             長さ/型 | 必須 | 説明    |
| ----------- | ---------------: | -: | ----- |
| order\_id   |      VARCHAR(32) |  ○ | 注文ID  |
| order\_date | DATE(YYYY-MM-DD) |  ○ | 注文日   |
| cust\_code  |      VARCHAR(20) |  ○ | 顧客コード |
| amount      |    DECIMAL(12,2) |  ○ | 金額    |

# 7. HULFT設定（ジョブ設計）

## 7.1 転送方式

* プッシュ方式：送信側HULFTから受信側HULFTへ転送実行
* ポーリング方式：受信側が定期的に受信フォルダをチェックして取り込み

## 7.2 ジョブ（Job）設定項目

* ジョブID／ジョブ名
* 送信元ディレクトリ／受信先ディレクトリ
* 転送タイミング（cron形式）
* 同時転送数の制御
* 再送ポリシー（リトライ回数、間隔）
* 通知設定（成功／失敗のメール/Slackなど）
* 圧縮転送の有無（GZIP等）
* ファイル転送完了後のアーカイブ/削除ポリシー

## 7.3 例：ジョブテンプレート

* JobID: HULFT\_ORD\_TO\_B
* 送信元: /data/outbound/ord/
* 受信先: /data/inbound/ord/
* 実行: 15分毎
* リトライ: 3回（間隔5分）
* 成功アクション: ファイルを /archive/sent/ に移動
* 失敗アクション: /archive/error/ に移動し担当へ通知

# 8. 連携フロー（シーケンス）

1. システムAでファイル生成（排他/ロック処理）
2. 一時ディレクトリに保存、整合性チェック（MD5/SHA256）
3. HULFT送信ジョブがファイルを取得し送信
4. 受信側HULFTで受信完了ログを出力
5. 受信側システムBでファイルを取込（トランザクション制御）
6. 取込結果を応答ファイルとして生成し返送
7. 両端でアーカイブ・監査ログを保存

# 9. 障害対応と例外処理

## 9.1 転送障害（通信断）

* 自動リトライルール適用（ジョブ設定に基づく）
* リトライ後も失敗した場合は通知（メール/チャット）
* 過去ログを利用して再送を手動で実施する手順を用意

## 9.2 ファイル不整合（破損、文字化け）

* 受信時にチェックサムと文字コード検査を実施
* 不整合の場合は受信済みでも移動せずエラー格納フォルダへ
* 発生時は発生時刻・ファイル名・エラー内容をログに残す

## 9.3 重複受信対策

* ファイル名重複検知（同名ファイルが既に処理済みかをDBでチェック）
* 重複時は処理ポリシーに従い上書き／スキップ／別名保存

# 10. セキュリティ要件

* 通信経路：TLSによる暗号化（可能な場合）
* ファイルの暗号化：必要に応じてPGP/GPGでの暗号化
* アクセス制御：HULFT実行ユーザの最小権限化、ディレクトリ権限管理
* ログ保全：転送ログ・監査ログの保存期間、改竄検知（ハッシュ保存）
* 機密データのマスキング要件（ログに機密データを記録しない）

# 11. 運用・監視要件

* 監視項目：ジョブステータス、転送成功率、転送時間、失敗数
* アラート閾値：失敗1件で即時通知、同一ジョブで3回連続失敗で高優先度通知
* 定期レポート：日次転送実績、月次障害分析
* 運用手順：定常手順、障害時手順（切替、再送、ログ収集）
* 保守窓口：担当者名、連絡先、エスカレーションフロー

# 12. テスト計画

## 12.1 結合テスト

* 正常系：複数ファイルの連続転送、負荷時の安定性
* 異常系：途中切断、ファイル破損、アクセス権エラー

## 12.2 運用テスト

* リカバリ手順の確認（手動再送、ロールバック）
* 監視アラートの受信確認

## 12.3 テストデータ

* 正常データ、異常データ（欠損、フォーマット外）、大容量データ

# 13. バックアップ・リカバリ

* 転送前・転送後のファイルは指定期間アーカイブ（例：90日）
* 重要データは別ストレージへ冗長保存
* インシデント発生時の復旧手順（手動再送手順、ログ復元）

# 14. 設定パラメータ一覧（サンプル）

| 項目         | 設定値（例）              | 備考 |
| ---------- | ------------------- | -- |
| HULFTバージョン | X.Y.Z               |    |
| 送信ディレクトリ   | /data/outbound/ord/ |    |
| 受信ディレクトリ   | /data/inbound/ord/  |    |
| リトライ回数     | 3                   |    |
| リトライ間隔     | 300（秒）              |    |

# 15. 添付（サンプル）

* HULFTジョブ定義サンプル（XML/CSV）
* ファイル仕様書（詳細レコード定義）
* 運用手順書（初動対応フロー）

# 16. 保守・変更管理

* ジョブ変更はチケット管理（JIRA等）に登録し、影響範囲の確認を必須とする
* 変更後は結合テスト通過と運用承認を得ること

# 17. 参考情報・問い合わせ先

* HULFTマニュアル（社内格納場所/ベンダー）
* システム担当：担当者名（メール / 内線）

---

