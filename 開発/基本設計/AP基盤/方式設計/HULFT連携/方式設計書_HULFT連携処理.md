# 方式設計書：HULFT連携処理

本書は、社内システムと外部（取引先／他システム）間でのファイル連携を、HULFT を用いて行うための基本設計を示す。対象はファイル生成側（送信元）・受信側・HULFT設定・運用監視・障害対応手順まで含む。

---

## 1. ドキュメント情報

* ドキュメント名：HULFT連携 基本設計書
* 作成日：`YYYY-MM-DD`
* バージョン：`v1.0`
* 作成者：`（作成者名）`
* 承認者：`（承認者名）`

---

## 2. 目的と背景

* 目的：システムAとシステムB間のデータ連携をHULFTで実現するための基本設計を定義する。
* 背景：手作業によるデータ転送の自動化、転送の信頼性向上、監査ログ確保。

---

## 3. 範囲（スコープ）

* 対象：日次バッチによるデータ連携（CSV / 固定長 / ZIP 等）、ファイル命名規約、暗号化/圧縮要件
* HULFT を用いた送受信（Push / Pull 両対応）
* 冪等性確保、再送・リトライ、通知フロー
* 監視・ログ・障害エスカレーション手順
  **※** API連携（SFTP以外のHTTP/REST）は別途設計（必要なら追加）。

---

## 4. 前提条件・制約

* HULFT バージョン：xxx（運用中のバージョンを明記）
* ネットワーク：送受信双方で通信ポート（デフォルト 554など）が許可されていること
* ファイル置き場は両端で同一のエンコーディング（UTF-8）を使用
* ファイルサイズ上限：1ファイルあたり **100MB**（要調整）
* 運用時間：バッチ夜間窓（例：毎日 02:00 実行）

---

## 5. 用語定義

* 送信元：データ生成システム（本システム）
* 受信先：取引先／外部システム
* HULFTノード：送信側/受信側のHULFTインスタンス
* Transfer Unit：1つの送受信ジョブ（ファイル単位）

---

## 6. 関係者（RACI）

* 発注：業務担当A（R）
* 開発：インフラチーム（A）
* 運用：運用チーム（C）
* テスト：品質保証（I）
  （責任を明確化：R=実行者、A=最終承認者、C=協力、I=通知）

---

## 7. システム構成概要

* 図（ここにネットワーク・配置図を貼る）
* 構成要素例：

  * HULFT Master/Client（サーバA：送信、サーバB：受信）
  * 送信アプリケーション（バッチジョブ）
  * 受信アプリケーション（取込バッチ）
  * 監視/アラート基盤（メール/監視ツール）
  * 証跡保存領域（アーカイブサーバ）

---

## 8. 非機能要件

* 可用性：SLA 99.5%（夜間バッチ時間帯）
* 応答性：ファイル生成→転送開始まで最大 10 分
* 冗長性：HULFT 冗長構成（マスター/スタンバイ）を推奨
* セキュリティ：転送は暗号化（SFTP/FTPS 等）を利用、転送ログの保管期間 1 年

---

## 9. 転送フロー（シーケンス）

1. 送信バッチが出力ファイルを指定フォルダに出力（例：`/data/outbound/`）
2. HULFTの送信プロセスが該当ファイルをピックアップ（トリガ/スケジュール）
3. ファイル名チェック（命名規約のバリデーション）
4. 送信前に圧縮（必要の場合）および暗号化（機密データ時）
5. HULFT経由でターゲットへ転送（TCP/IP）
6. 受信側HULFTが整合性チェック（サイズ、チェックサム）
7. 受信完了通知を送信元へ返却（ACK）
8. 受信後、取込プロセスがファイルを処理、処理結果をログ/メールで報告
9. 転送ファイルは一定期間アーカイブ後に削除（保持ポリシー）

---

## 10. ファイル仕様（例）

### 10.1 共通ルール

* 文字コード：UTF-8（BOMなし）
* 改行コード：LF（\n）
* フィールド区切り：カンマ（,）
* ヘッダ行：あり（1行目、項目名）
* NULL表現：空文字
* ファイル名規約：`[送信先コード]_[データ種別]_[YYYYMMDD]_[SEQ].csv`
  例：`CUST01_ORD_20250810_001.csv`
* サンプルレコード：`<カラム名>,<型>,<長さ>,<説明>`（別表で詳細定義）

### 10.2 CSV項目例（受注データ）

1. order\_id（文字列、必須）
2. order\_date（YYYY-MM-DD、必須）
3. customer\_code（文字列、必須）
4. product\_code（文字列、必須）
5. quantity（整数、必須）
6. unit\_price（小数、任意）
7. currency（3桁、任意）
8. remarks（長文、任意）

（各項目の型・桁数・必須/任意・サンプル値を別表で定義）

---

## 11. HULFT設定方針（送信側）

* 送信ジョブ名：`SND_[送信先コード]_[データ種別]`
* 監視ディレクトリ（送信元）：`/data/outbound/[送信先]/pending/`
* 完了移動先：`/data/outbound/[送信先]/done/`
* 失敗移動先：`/data/outbound/[送信先]/error/`
* 送信プロトコル：SFTP（鍵認証）／FTPS（TLS）／FTP（不可推奨）
* 接続設定：ホスト名、ポート、ユーザ、鍵ファイルパス（機密情報はVaultで管理）
* 事後処理：送信完了時にフックでステータス更新APIを呼ぶ（必要に応じて）

### サンプル（HULFT設定概念）

```
Job: SND_CUST01_ORD
Source Dir: /data/outbound/CUST01/pending
Target Host: ftp.cust01.example.com
Target Dir: /inbound/orders
Protocol: SFTP
Retry Policy: 3回（初回間隔=5分, 指数バックオフ）
Post-action: move to /data/outbound/CUST01/done
Notify: send mail to ops-team@company.example.com on failure
```

---

## 12. 受信側設計（取引先から受ける場合）

* 受信監視ディレクトリ：`/data/inbound/[送信元]/pending/`
* 受信後の処理：

  1. ファイル名ルールチェック
  2. ヘッダ・件数・整合性チェック（レコード数検証）
  3. 重複チェック（同一ファイル名 or MD5）
  4. 正常 → インポート処理実行、完了後アーカイブ
  5. 異常 → errorフォルダへ移動、通知
* ACK/レスポンス：受領結果をメール／FTP ACKファイル／APIで通知（取引先仕様に合わせる）

---

## 13. エラーハンドリング／再送設計

* 送信失敗（接続不可等）

  * 自動リトライ：最大3回（間隔 5分→10分→20分）
  * 再試行後も失敗 → `error` フォルダに移動 + 運用チケット作成（例：PagerDuty or メール）
  
* 受信エラー（フォーマット不整合）

  * 受信側で詳細ログ生成（行番号、内容、エラー理由）
  * 受信側は送信元へ差し戻し（NGファイル + エラー報告）
  
* 重複検知

  * ファイル名／チェックサムで判定。重複の場合は自動破棄または上書き（要運用ルール）
* 手動再送手順を作成（管理画面 or CLI）

* 処理中断時の手順：

  1. 隔離フォルダ確認
  2. 送信ログ／受信ログの取得
  3. 手動再転送可否判断（再送は基本自動で行うが、データ不整合がある場合は手動）
* SLA（例）：転送開始から確認まで最大15分以内に完了（通常処理は5分以内）

---

## 14. 監視・通知

* 監視項目

  * ジョブ実行状態（成功/失敗）
  * 未処理ファイル数（pending フォルダ）
  * 最終受信／送信日時（閾値超過アラート）
  * 転送速度・平均転送時間
* 通知ルール：
  * 致命的エラー（再試行後もエラー）：即時SMS/電話＋メール
  * 軽微なエラー：メール（運用時間内）
* 通知チャネル：メール + Slack（opsチャンネル） + SMS（クリティカル）
* ログ保存：転送ログ（送信側/受信側）を 1 年保存。ログはWORM対応（必要な場合）
  * 転送ログ：90日（あるいは監査要件に応じて延長）
  * 監査ログ：最低1年（規制により変更）
* 定期作業：
  * 日次ジョブ：正常転送件数チェック、異常検知
  * 週次：ログローテーション確認、ディスク使用量確認
  * 月次：証明書有効期限確認、パッチ適用計画

---

## 15. セキュリティ

* 通信：TLS 1.2以上を必須とする（証明書管理を明記）
* 認証：HULFTの通信ユーザは個別アカウントを使用し、鍵（証明書）で管理、鍵認証（SFTP）、もしくはFTPSでTLS利用
* 暗号化：通信経路は常時暗号化
* 鍵管理：PKIまたはVaultで集中管理、鍵ローテーションは定期実施（例：90日毎）
* アクセス制御：HULFTノードへのアクセスは限定IP・管理者のみ（最低限の権限設定（原則：最低限の権限設定でサービスアカウントのみ）
* 機密データ：ファイルに機密項目が含まれる場合はファイル単位で暗号化（PGP）を検討
* ログ保全：操作ログ、転送ログを改ざん検知可能な形で保管（必要ならWORM）

---

## 16. 運用・作業フロー

### 日次フロー（例）

1. 01:50 バッチ開始（DB→CSV生成）
2. 02:00 HULFT送信ジョブ起動（自動）
3. 02:10 送信完了通知 / 受信側ACK待ち
4. 03:00 受信側ACK未着の場合は自動リトライ → 失敗時はオペレーター通知

### 定常作業

* 日次：転送成功件数確認（ops）
* 週次：エラー件数レビュー
* 月次：鍵ローテーション、バージョンパッチ適用

---

## 17. テスト計画（受け入れ条件）

### テスト項目

* 正常系：ファイル生成→送信→受信→ACK受領までの一連処理
* 境界値：大容量ファイル（100MB近傍）、最大レコード数
* エラー系：接続途絶、部分的フォーマット不整合、重複ファイル
* リカバリ：中断後の再送、リトライ挙動
* 性能：並列ジョブ数を増やした際の転送時間

### 受入基準（例）

* 正常送受信成功率 99.9%（テスト期間内）
* エラー時に自動で所定の通知が発報されること
* 再送手順で正常復旧が可能であること

---

## 18. 移行・デプロイ手順（概要）

1. ステージング環境にHULFT設定を適用（Job / 監視 / ロギング）
2. 受信側（取引先）と相互接続テスト（鍵交換、接続確認）
3. テストデータで総合試験（正・異常ケース）
4. 本番切替：DNS / IP 設定、cronジョブ切替、監視閾値調整
5. リリース後 1 週間はパラメータと運用状況を密に監視

---

## 19. ログ・監査項目（必須）

* 転送日時（送受信）
* ファイル名、サイズ、レコード数、MD5
* 送信元ノード / 受信先ノード
* 転送結果（成功/失敗）、エラーコード、詳細メッセージ
* 操作履歴（誰が手動で再送したか）

---

## 20. 例：HULFT転送設定（テンプレ：概念）

（実GUI設定は管理画面により差分あり。以下は運用仕様として保存）

```
TransferJob:
  id: SND_CUST01_ORD
  source_dir: /data/outbound/CUST01/pending
  file_pattern: CUST01_ORD_*.csv
  protocol: sftp
  target:
    host: sftp.cust01.example.com
    port: 22
    user: hulft_user
    private_key: /etc/hulft/keys/cust01_id_rsa
    dest_dir: /inbound/orders
  retry:
    max_attempts: 3
    initial_interval_min: 5
    backoff: exponential
  post_actions:
    - move: /data/outbound/CUST01/done
    - notify: ops@company.example.com
```

---

## 21. 付録（サンプル）

### A. サンプルCSV（1行）

```
order_id,order_date,customer_code,product_code,quantity,unit_price,currency,remarks
ORD000123,2025-08-10,CUST01,PRD-A001,10,120.5,JPY,通常注文
```

### B. エラーメッセージ例

* `E001: CONNECTION_TIMEOUT` — 接続タイムアウト
* `E002: AUTH_FAIL` — 認証失敗
* `E003: FORMAT_ERROR at line 45` — フォーマット不整合

---

## 22. 受け渡し（成果物）

* 本基本設計書（Word / PDF）
* ファイル項目定義書（CSVでの詳細定義）
* HULFT ジョブ定義テンプレート（JSON or YAML）
* 運用手順書（日次／障害対応）

---


