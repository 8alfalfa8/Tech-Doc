
# AP基盤 基本設計書（テンプレート）
AP基盤（アプリケーション基盤）の\*\*基本設計書（テンプレート兼プロジェクト向け骨子）\*\*を作成しました。業務システムの標準的な要件（可用性・運用性・拡張性・セキュリティ）を満たすことを目的に、設計方針・構成要素・運用ルール・SLO/監視・運用手順までカバーしています。プロジェクト環境（クラウド事業者／オンプレ／コンテナかVMか等）に合わせてすぐカスタマイズできるように要点と例を盛り込みました。

---

## 0. 表紙・管理情報

* ドキュメント名：AP基盤基本設計書（システム名）
* バージョン：v1.0
* 作成日：YYYY/MM/DD
* 作成者／所属：
* 承認者／承認日：
* 関連資料：要件定義書、ネットワーク設計書、セキュリティ基準

---

## 1. 目的・適用範囲

* 目的：アプリケーションを安定的／安全に稼働させるためのプラットフォーム（AP基盤：実行環境、ミドルウェア、CI/CD、監視、運用プロセス等）を定義する。
* 適用範囲：アプリ実行基盤、共通ミドルウェア、デプロイ手順、運用監視、ログ管理、バックアップ、DR 等（除外：個別アプリの業務ロジック、DBのスキーマ設計等）

---

## 2. 要件（抜粋）

* 可用性：稼働率99.9%（月間目標）、フェイルオーバ時間 < 5分 等
* 性能：P95 応答時間 < 3s、同時接続数 N、スループット M req/s
* スケーラビリティ：ピーク時自動スケール
* セキュリティ：TLS 1.2/1.3、RBAC、ログ監査、脆弱性スキャン
* 運用性：CI/CD による自動デプロイ、Infrastructure as Code、インシデント手順の整備
* コンプライアンス：ログ保持期間、個人情報管理方針等

---

## 3. 基本方針（設計原則）

* 変更容易性：インフラはIaCで管理（Terraform/CloudFormation 等）
* 可観測性：メトリクス/ログ/トレースを標準収集（Prometheus/ELK/Opentelemetry 等）
* セキュア・デフォルト：最小権限・TLS必須・機密データ暗号化
* 自動化：CI/CD、テスト、デプロイ、ロールバックを自動化
* 冗長化：単一障害点を排除（AZ複数利用等）

---

## 4. 全体アーキテクチャ（論理）

* クライアント（ブラウザ/Mobile） ⇄ CDN ⇄ API Gateway / Load Balancer ⇄ アプリ層（コンテナ or VM）⇄ データ層（RDB/NoSQL/Cache）⇄ バッチ/バッファ（キュー）
  （図：論理構成図をここに挿入）

---

## 5. コンポーネント設計（主要要素）

### 5.1 エッジ（公開）

* CDN：静的コンテンツのキャッシュ（例：CloudFront / Akamai / Fastly）
* WAF：OWASP対策、IPレート制御（例：AWS WAF）
* TLS 終端：ALB/CloudLBまたはCDN上で終端（証明書管理：ACM / Let's Encrypt / HashiCorp Vault）

### 5.2 ネットワーク

* VPC（クラウド）/ VLAN（オンプレ）設計：パブリックサブネット、プライベートサブネット、管理サブネット
* セキュリティグループ / NACL：最小接続許可
* ネットワーク分離：アプリ系／DB系／管理系のセグメント分離

### 5.3 ロードバランサ

* 外部ALB（L7）＋内部ALB（L4/L7）構成
* ヘルスチェックポリシー、タイムアウト設定

### 5.4 実行基盤（アプリ層）

選択肢（どれかを採用）：

* コンテナ基盤（推奨）：

  * Kubernetes（マネージド EKS/GKE/AKS or 自己管理）
  * Pod設計、Namespace分割、ResourceQuota、Horizontal Pod Autoscaler
* VMベース：

  * VMをAutoScaling Groupで構成（AMI管理）
* PaaS：

  * Cloud Run / App Engine 等（用途により）

### 5.5 ミドルウェア

* API Gateway（認証/ルーティング/レート制限）
* Service Mesh（必要なら Istio/Linkerd）
* セッション管理（ステートレス推奨／Redis等でセッション保持）
* キャッシュ：Redis / Memcached（マネージド or クラスター）
* メッセージング：RabbitMQ / Kafka / SQS（非同期処理用）

### 5.6 データベース連携

* RDB（主系）：RDS / CloudSQL / オンプレDB（マスター・リードレプリカ）
* バックアップポリシー、スナップショット、Point-in-Time Recovery
* ストレージ暗号化（at-rest）、接続はVPC経由（Private）

### 5.7 永続ストレージ

* ブロックストレージ（EBS等）/ オブジェクトストレージ（S3等）
* ログ/アーティファクト用バケットポリシー、ライフサイクル設定

### 5.8 CI/CD

* Gitベース（GitHub/GitLab/Bitbucket）
* CI：Unit → Integration → E2E テスト自動化（GitHub Actions, GitLab CI, Jenkins）
* CD：イメージビルド→レジストリ→デプロイ（ArgoCD/Flux/CDK/Spinnaker）
* 環境：dev → staging → prod、promotion手順と自動化

### 5.9 ログ・監視・トレーシング（可観測性）

* ロギング：アプリ → Fluentd/FluentBit → ELK / OpenSearch（ログ構造化）
* メトリクス：Prometheus（アプリ/infraメトリクス）＋Grafanaダッシュボード
* トレーシング：OpenTelemetry / Jaeger（分散トレース）
* アラート：PagerDuty / OpsGenie / Slack通知、アラート基準（例：5分間エラー率5%超）

### 5.10 セキュリティ

* 認証：OAuth2/OpenID Connect、SAML（SSO）
* 認可：RBAC / ABAC、最小権限
* シークレット管理：HashiCorp Vault / AWS Secrets Manager / KMS
* 脆弱性管理：定期スキャン（ソフトウェアSBOM、コンテナイメージスキャン）
* レポーティング：監査ログ（アクセスログ/管理操作ログ）の保存と監査

---

## 6. 非機能要件（NFR）具体化

* 可用性：AZ跨ぎ冗長、DBはマルチAZ／リードレプリカ、RTO=1時間、RPO=15分（例）
* 性能：ピーク同時接続 10,000、P95 レスポンス < 2.5s、スループット 200 req/s（プロジェクト固有の数値で上書き）
* セキュリティ：重要データはAES-256で保存、通信はTLS 1.2以上
* 保守性：IaCカバレッジ100%、自動テストカバレッジの目標 70% 以上

---

## 7. 運用・保守設計

### 7.1 運用体制

* 1次/2次/3次の連絡フロー、担当チーム、オンコール体制
* エスカレーションルール、連絡先一覧（セキュアに管理）

### 7.2 モニタリング＆ダッシュボード

* 必須ダッシュボード（サービス健全性、レスポンスタイム、エラー率、CPU/Memory、DBレイテンシ）
* 定期レポート（週次/月次）

### 7.3 ログ管理

* 保持期間（例：運用ログ 90日、監査ログ 7年）
* アクセス制御、監査トレイル

### 7.4 バックアップとリストア

* DB：日次フル＋増分、週次保管、リストア手順の定期検証（年2回以上）
* オブジェクトストレージ：バージョニング、ライフサイクル
* 自動化スクリプト＋手順書（リストア時間の目標値）

### 7.5 障害対応（Runbook）

* 典型インシデントと対処手順（例：Pod CrashLoopBackOff、DB切替、ネットワーク断）
* ロールバックとカナリアリリース手順
* 事後対応（Post-mortem）テンプレート

---

## 8. セキュリティ設計詳細

* ネットワークACL、セグメント設計
* K8s セキュリティ：PodSecurityPolicies / OPA Gatekeeper、Admission Controller
* コンテナイメージポリシー：署名、スキャン、最小ベースイメージ
* IAMポリシーの命名規約・付与プロセス
* セキュリティバグ対応 SLA（例：Critical は24時間以内に対応方針提示）

---

## 9. デプロイ・リリース設計

* デプロイ方式（Blue/Green or Canary）
* リリース手順：ビルド→テスト→ステージング→プロダクション、承認フロー
* ロールバック条件と自動化（失敗時は自動で旧バージョンへ戻す）
* バージョニング方針（SemVer 推奨）

---

## 10. DR（Disaster Recovery）設計

* DRシナリオ（AZ障害／リージョン障害）
* リカバリ手順、DRサイト（Warm/Hot/Cold）と復旧時間目標
* 定期演習計画（年1回以上のDR演習）

---

## 11. コスト／キャパシティ計画

* 初期リソース見積り（インスタンス数、ストレージ、転送）
* スケーリングポリシーによるコスト試算
* コスト最適化方針（Reserved/Spot、ライフサイクルポリシー等）

---

## 12. 運用ドキュメント・成果物

* IaC リポジトリ（Terraform等）
* CI/CD 設定（YAML）
* Runbook（運用手順書）
* モニタリング・ダッシュボード定義
* セキュリティポリシーと監査証跡

---

## 13. リスクと対応策（抜粋）

* 外部APIの仕様変更 → インタフェースアダプタで吸収、契約で通知義務を要求
* K8sクラスタのバージョン互換性 → 事前QAとCanaryの運用
* 運用人員不足 → SRE 導入、Runbook充実、自動化投資

---

## 14. 設計レビュー／承認

* レビュー項目リスト（セキュリティ、可用性、運用性、バックアップ、テスト計画 等）
* 承認者（インフラ責任者、セキュリティ責任者、業務責任者）

---

## 15. チェックリスト（短縮版）

* [ ] IaCによるインフラ定義がある
* [ ] CI/CDパイプラインが自動化されている
* [ ] 監視/アラート閾値が定義済み
* [ ] バックアップ・RTO/RPOが定義済み
* [ ] セキュリティ（TLS・Secret管理・脆弱性スキャン）が実装可能
* [ ] DR計画・演習の計画がある
* [ ] 運用担当のオンコール/エスカレーションが決まっている

---

