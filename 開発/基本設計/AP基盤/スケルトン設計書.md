# Spring Boot スケルトン設計書 (AP基盤)

## 1. プロジェクト概要

### 1.1 目的
本設計書は、Spring Bootを基盤としたAP(アプリケーション)開発における標準的なスケルトン構成を定義する。

### 1.2 適用範囲
- 新規開発するSpring BootベースのAPアプリケーション
- マイクロサービスアーキテクチャを採用するシステム
- REST APIを提供するバックエンドサービス

## 2. プロジェクト構造

### 2.1 ディレクトリ構成

```
src/main/java/com/company/[appname]/
├── config/            # 設定関連クラス
├── controller/        # RESTコントローラ
├── service/           # ビジネスロジック
│   ├── impl/          # サービス実装クラス
├── repository/        # データアクセス層
│   ├── entity/        # エンティティクラス
│   ├── dao/           # DAOインターフェース(JPA or MyBatis)
├── dto/               # データ転送オブジェクト
├── exception/         # 例外処理関連
├── util/              # ユーティリティクラス
├── validation/        # バリデーション関連
└── [AppName]Application.java  # メインアプリケーションクラス

src/main/resources/
├── application.yml    # アプリケーション設定
├── application-dev.yml # 開発環境設定
├── application-prod.yml # 本番環境設定
├── messages/          # メッセージプロパティ
├── static/            # 静的リソース
└── templates/         # テンプレートファイル
```

## 3. 技術スタック

### 3.1 基本技術

| カテゴリ       | 技術選定               |
|----------------|------------------------|
| フレームワーク | Spring Boot 3.x        |
| ビルドツール   | Maven/Gradle           |
| 言語           | Java 17+               |
| API仕様        | OpenAPI 3.0            |

### 3.2 主要ライブラリ

| 目的               | ライブラリ                     |
|--------------------|-------------------------------|
| データアクセス     | Spring Data JPA / MyBatis     |
| データベース       | H2 (開発), PostgreSQL (本番)  |
| キャッシュ         | Redis                         |
| 認証・認可         | Spring Security               |
| ロギング           | SLF4J + Logback               |
| テスト             | JUnit 5, Mockito, Testcontainers |
| メトリクス         | Micrometer + Prometheus       |
| APIドキュメント    | SpringDoc OpenAPI             |

## 4. コアコンポーネント設計

### 4.1 アプリケーション設定

```java
@SpringBootApplication
@EnableConfigurationProperties({
    AppProperties.class,
    SecurityProperties.class
})
public class MyAppApplication {
    public static void main(String[] args) {
        SpringApplication.run(MyAppApplication.class, args);
    }
}
```

### 4.2 RESTコントローラ例

```java
@RestController
@RequestMapping("/api/v1/users")
@RequiredArgsConstructor
@Tag(name = "User Management", description = "ユーザー管理API")
public class UserController {

    private final UserService userService;

    @GetMapping
    @Operation(summary = "ユーザー一覧取得")
    public ResponseEntity<Page<UserDto>> getUsers(
            @ParameterObject @PageableDefault Pageable pageable) {
        return ResponseEntity.ok(userService.findAll(pageable));
    }

    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "新規ユーザー登録")
    public UserDto createUser(@Valid @RequestBody UserCreateRequest request) {
        return userService.create(request);
    }
}
```

### 4.3 サービス層設計

```java
public interface UserService {
    Page<UserDto> findAll(Pageable pageable);
    UserDto create(UserCreateRequest request);
    UserDto findById(Long id);
}

@Service
@Transactional
@RequiredArgsConstructor
@Slf4j
public class UserServiceImpl implements UserService {

    private final UserRepository userRepository;
    private final ModelMapper modelMapper;

    @Override
    public Page<UserDto> findAll(Pageable pageable) {
        return userRepository.findAll(pageable)
                .map(user -> modelMapper.map(user, UserDto.class));
    }

    @Override
    public UserDto create(UserCreateRequest request) {
        User user = modelMapper.map(request, User.class);
        user = userRepository.save(user);
        return modelMapper.map(user, UserDto.class);
    }
}
```

### 4.4 リポジトリ層設計

```java
public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByEmail(String email);
    boolean existsByEmail(String email);
}

@Entity
@Table(name = "users")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, unique = true)
    private String email;
    
    @Column(nullable = false)
    private String name;
    
    @CreationTimestamp
    private LocalDateTime createdAt;
    
    @UpdateTimestamp
    private LocalDateTime updatedAt;
}
```

## 5. 共通機能設計

### 5.1 例外処理

```java
@ControllerAdvice
@Slf4j
@RequiredArgsConstructor
public class GlobalExceptionHandler {

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ErrorResponse> handleValidationException(
            MethodArgumentNotValidException ex) {
        
        List<String> errors = ex.getBindingResult()
                .getFieldErrors()
                .stream()
                .map(error -> error.getField() + ": " + error.getDefaultMessage())
                .collect(Collectors.toList());

        ErrorResponse response = new ErrorResponse(
                "VALIDATION_ERROR",
                "入力値チェックエラー",
                errors);
        
        return ResponseEntity.badRequest().body(response);
    }

    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<ErrorResponse> handleResourceNotFound(
            ResourceNotFoundException ex) {
        ErrorResponse response = new ErrorResponse(
                "NOT_FOUND",
                ex.getMessage());
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(response);
    }
}
```

### 5.2 ロギング設計

```java
@Aspect
@Component
@Slf4j
@RequiredArgsConstructor
public class LoggingAspect {

    @Around("execution(* com.company..*Controller.*(..))")
    public Object logController(ProceedingJoinPoint joinPoint) throws Throwable {
        String className = joinPoint.getTarget().getClass().getSimpleName();
        String methodName = joinPoint.getSignature().getName();
        
        log.info("Controller Start: {}.{}() with argument[s] = {}", 
                className, methodName, Arrays.toString(joinPoint.getArgs()));
        
        try {
            Object result = joinPoint.proceed();
            
            log.info("Controller End: {}.{}() with result = {}", 
                    className, methodName, result);
            
            return result;
        } catch (Exception e) {
            log.error("Exception in {}.{}(): {}", className, methodName, e.getMessage());
            throw e;
        }
    }
}
```

## 6. 設定ファイル例

### 6.1 application.yml

```yaml
spring:
  application:
    name: my-application
  profiles:
    active: dev
  datasource:
    url: jdbc:h2:mem:testdb
    username: sa
    password:
    driver-class-name: org.h2.Driver
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        format_sql: true
  cache:
    type: redis
  redis:
    host: localhost
    port: 6379

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always

logging:
  level:
    root: INFO
    org.springframework.web: DEBUG
    com.company: DEBUG
```

## 7. テスト戦略

### 7.1 テスト構成

```
src/test/java/
├── com/company/[appname]/
│   ├── controller/    # コントローラテスト
│   ├── service/       # サービス層テスト
│   ├── repository/    # リポジトリテスト
│   └── integration/   # 統合テスト
└── resources/
    ├── test-data.sql  # テストデータ
    └── application-test.yml # テスト用設定
```

### 7.2 テスト例

```java
@WebMvcTest(UserController.class)
@Import({UserServiceImpl.class, SecurityConfig.class})
@AutoConfigureMockMvc(addFilters = false)
class UserControllerTest {

    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private UserRepository userRepository;
    
    @Test
    @DisplayName("ユーザー一覧取得 - 成功")
    void getUsers_success() throws Exception {
        // テストデータ準備
        List<User> users = Arrays.asList(
                new User(1L, "user1@example.com", "User 1"),
                new User(2L, "user2@example.com", "User 2"));
        
        given(userRepository.findAll(any(Pageable.class)))
                .willReturn(new PageImpl<>(users));
        
        // リクエスト実行 & 検証
        mockMvc.perform(get("/api/v1/users")
                .contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.content", hasSize(2)))
                .andExpect(jsonPath("$.content[0].email", is("user1@example.com")));
    }
}
```

## 8. デプロイ設計

### 8.1 コンテナ化

```dockerfile
FROM eclipse-temurin:17-jdk-jammy

WORKDIR /app

COPY build/libs/*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 8.2 CI/CDパイプライン

1. ソースコードチェックアウト
2. ユニットテスト実行
3. ビルド (./gradlew build)
4. コンテナイメージビルド
5. イメージリポジトリへプッシュ
6. デプロイ (Kubernetes/ECSなど)

## 9. セキュリティ設計

### 9.1 セキュリティ設定例

```java
@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private final JwtAuthenticationFilter jwtAuthFilter;
    private final AuthenticationProvider authenticationProvider;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .csrf(AbstractHttpConfigurer::disable)
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/v1/auth/**").permitAll()
                .requestMatchers("/swagger-ui/**", "/v3/api-docs/**").permitAll()
                .anyRequest().authenticated()
            )
            .sessionManagement(sess -> 
                sess.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authenticationProvider(authenticationProvider)
            .addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);
        
        return http.build();
    }
}
```

## 10. 監視・運用設計

### 10.1 ヘルスチェック

```java
@RestController
@RequestMapping("/manage")
public class ManagementController {

    @GetMapping("/health")
    public ResponseEntity<String> healthCheck() {
        return ResponseEntity.ok("OK");
    }

    @GetMapping("/info")
    public ResponseEntity<Map<String, String>> appInfo() {
        Map<String, String> info = new HashMap<>();
        info.put("version", "1.0.0");
        info.put("buildTime", Instant.now().toString());
        return ResponseEntity.ok(info);
    }
}
```

### 10.2 メトリクス収集

```yaml
management:
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
```

以上がSpring Bootを基盤としたAP開発の標準スケルトン設計書となります。プロジェクトの要件に応じて適宜カスタマイズしてください。

---

# Spring Boot with JSP スケルトン設計書 (AP基盤)

## 1. プロジェクト拡張概要

### 1.1 目的
既存のSpring Boot REST API基盤にJSP画面機能を追加するための設計拡張

### 1.2 適用範囲
- Spring BootでJSPを使用する画面機能
- サーバーサイドレンダリングが必要な管理画面など
- ハイブリッド（API + JSP）構成のアプリケーション

## 2. プロジェクト構造拡張

### 2.1 ディレクトリ構成追加

```
src/main/
├── java/
│   └── com/company/[appname]/
│       ├── controller/
│       │   ├── api/      # REST APIコントローラ
│       │   └── web/      # JSP用コントローラ
│       └── validation/   # フォームバリデーション
├── resources/
│   └── messages/        # 画面メッセージプロパティ
└── webapp/
    ├── WEB-INF/
    │   ├── views/       # JSPファイル
    │   └── tags/        # カスタムタグ
    ├── static/          # 静的リソース (js/css/images)
    └── jsp/             # またはこちらにJSPを配置
```

## 3. 技術スタック追加

### 3.1 追加技術

| カテゴリ       | 技術選定               |
|----------------|------------------------|
| ビュー技術     | JSP 2.3               |
| タグライブラリ | JSTL 1.2              |
| テンプレート   | Spring Formタグ       |
| レイアウト     | Tiles 3 or SiteMesh   |

## 4. JSP対応設定

### 4.1 依存関係追加 (pom.xml)

```xml
<!-- JSPサポート -->
<dependency>
    <groupId>org.apache.tomcat.embed</groupId>
    <artifactId>tomcat-embed-jasper</artifactId>
    <scope>provided</scope>
</dependency>

<!-- JSTL -->
<dependency>
    <groupId>javax.servlet</groupId>
    <artifactId>jstl</artifactId>
</dependency>

<!-- Tiles (オプション) -->
<dependency>
    <groupId>org.apache.tiles</groupId>
    <artifactId>tiles-jsp</artifactId>
    <version>3.0.8</version>
</dependency>
```

### 4.2 設定ファイル追加 (application.yml)

```yaml
spring:
  mvc:
    view:
      prefix: /WEB-INF/views/
      suffix: .jsp
    static-path-pattern: /static/**
```

## 5. Webコントローラ設計

### 5.1 基本コントローラ例

```java
@Controller
@RequestMapping("/web/users")
@RequiredArgsConstructor
public class UserWebController {

    private final UserService userService;

    @GetMapping
    public String listUsers(
        @RequestParam(defaultValue = "1") int page,
        @RequestParam(defaultValue = "10") int size,
        Model model) {
        
        Pageable pageable = PageRequest.of(page - 1, size);
        Page<UserDto> userPage = userService.findAll(pageable);
        
        model.addAttribute("users", userPage.getContent());
        model.addAttribute("pageInfo", new PageInfo(userPage));
        
        return "users/list"; // /WEB-INF/views/users/list.jsp
    }

    @GetMapping("/create")
    public String showCreateForm(Model model) {
        model.addAttribute("userForm", new UserForm());
        return "users/create";
    }

    @PostMapping("/create")
    public String createUser(
        @Valid @ModelAttribute("userForm") UserForm form,
        BindingResult result,
        RedirectAttributes redirectAttributes) {
        
        if (result.hasErrors()) {
            return "users/create";
        }
        
        userService.create(form.toRequest());
        redirectAttributes.addFlashAttribute("message", "ユーザーを作成しました");
        
        return "redirect:/web/users";
    }
}
```

### 5.2 フォームクラス例

```java
@Getter
@Setter
@NoArgsConstructor
public class UserForm {

    @NotBlank(message = "{validation.user.name.required}")
    @Size(max = 50, message = "{validation.user.name.size}")
    private String name;

    @NotBlank(message = "{validation.user.email.required}")
    @Email(message = "{validation.user.email.format}")
    private String email;

    public UserCreateRequest toRequest() {
        return new UserCreateRequest(name, email);
    }
}
```

## 6. JSP実装例

### 6.1 基本テンプレート (layout.jsp)

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form" %>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title><spring:message code="app.title" /> - <sitemesh:write property='title'/></title>
    <link rel="stylesheet" href="<c:url value='/static/css/style.css'/>">
</head>
<body>
    <header>
        <h1><spring:message code="app.header" /></h1>
    </header>
    
    <nav>
        <ul>
            <li><a href="<c:url value='/web/users'/>">ユーザー一覧</a></li>
        </ul>
    </nav>
    
    <main>
        <sitemesh:write property='body'/>
    </main>
    
    <footer>
        <p>&copy; <spring:message code="app.footer" /></p>
    </footer>
    
    <script src="<c:url value='/static/js/main.js'/>"></script>
</body>
</html>
```

### 6.2 ユーザー一覧画面 (list.jsp)

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %>

<sitemesh:decorate decorator="/WEB-INF/layouts/layout.jsp">
    <sitemesh:param name="title">ユーザー管理</sitemesh:param>
    
    <sitemesh:write property='body'>
        <h2>ユーザー一覧</h2>
        
        <a href="<c:url value='/web/users/create'/>" class="btn btn-primary">
            新規登録
        </a>
        
        <c:if test="${not empty message}">
            <div class="alert alert-success">${message}</div>
        </c:if>
        
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>名前</th>
                    <th>メールアドレス</th>
                    <th>登録日</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                <c:forEach items="${users}" var="user">
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>
                            <fmt:formatDate value="${user.createdAt}" pattern="yyyy/MM/dd" />
                        </td>
                        <td>
                            <a href="<c:url value='/web/users/${user.id}'/>" class="btn btn-info">詳細</a>
                        </td>
                    </tr>
                </c:forEach>
            </tbody>
        </table>
        
        <!-- ページネーション -->
        <div class="pagination">
            <c:if test="${pageInfo.hasPrevious}">
                <a href="<c:url value='/web/users?page=${pageInfo.current-1}'/>">前へ</a>
            </c:if>
            
            <c:forEach begin="1" end="${pageInfo.totalPages}" var="i">
                <c:choose>
                    <c:when test="${i eq pageInfo.current}">
                        <span class="current">${i}</span>
                    </c:when>
                    <c:otherwise>
                        <a href="<c:url value='/web/users?page=${i}'/>">${i}</a>
                    </c:otherwise>
                </c:choose>
            </c:forEach>
            
            <c:if test="${pageInfo.hasNext}">
                <a href="<c:url value='/web/users?page=${pageInfo.current+1}'/>">次へ</a>
            </c:if>
        </div>
    </sitemesh:write>
</sitemesh:decorate>
```

### 6.3 ユーザー登録画面 (create.jsp)

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>

<sitemesh:decorate decorator="/WEB-INF/layouts/layout.jsp">
    <sitemesh:param name="title">ユーザー登録</sitemesh:param>
    
    <sitemesh:write property='body'>
        <h2>ユーザー登録</h2>
        
        <form:form modelAttribute="userForm" action="/web/users/create" method="post" cssClass="form-horizontal">
            <div class="form-group">
                <form:label path="name" cssClass="control-label">名前</form:label>
                <form:input path="name" cssClass="form-control" />
                <form:errors path="name" cssClass="error-message" />
            </div>
            
            <div class="form-group">
                <form:label path="email" cssClass="control-label">メールアドレス</form:label>
                <form:input path="email" cssClass="form-control" />
                <form:errors path="email" cssClass="error-message" />
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">登録</button>
                <a href="<c:url value='/web/users'/>" class="btn btn-default">キャンセル</a>
            </div>
        </form:form>
    </sitemesh:write>
</sitemesh:decorate>
```

## 7. セキュリティ拡張

### 7.1 Webセキュリティ設定

```java
@Configuration
@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
                .antMatchers("/static/**", "/webjars/**").permitAll()
                .antMatchers("/web/login").permitAll()
                .antMatchers("/web/**").authenticated()
                .and()
            .formLogin()
                .loginPage("/web/login")
                .defaultSuccessUrl("/web/dashboard")
                .permitAll()
                .and()
            .logout()
                .logoutUrl("/web/logout")
                .logoutSuccessUrl("/web/login?logout")
                .permitAll();
    }
}
```

### 7.2 ログインコントローラ

```java
@Controller
@RequestMapping("/web")
public class LoginController {

    @GetMapping("/login")
    public String login(
        @RequestParam(value = "error", required = false) String error,
        @RequestParam(value = "logout", required = false) String logout,
        Model model) {
        
        if (error != null) {
            model.addAttribute("error", "ログインIDまたはパスワードが不正です");
        }
        
        if (logout != null) {
            model.addAttribute("message", "ログアウトしました");
        }
        
        return "login";
    }
    
    @GetMapping("/dashboard")
    public String dashboard() {
        return "dashboard";
    }
}
```

## 8. 国際化対応

### 8.1 メッセージプロパティ (messages.properties)

```
app.title=Spring Boot JSPアプリケーション
app.header=管理システム
app.footer=Copyright © 2023 Company, Inc. All rights reserved.

validation.user.name.required=名前は必須入力です
validation.user.name.size=名前は50文字以内で入力してください
validation.user.email.required=メールアドレスは必須入力です
validation.user.email.format=正しいメールアドレス形式で入力してください

button.submit=送信
button.cancel=キャンセル
```

### 8.2 ロケールリゾルバ設定

```java
@Configuration
public class LocaleConfig implements WebMvcConfigurer {

    @Bean
    public LocaleResolver localeResolver() {
        SessionLocaleResolver slr = new SessionLocaleResolver();
        slr.setDefaultLocale(Locale.JAPAN);
        return slr;
    }

    @Bean
    public LocaleChangeInterceptor localeChangeInterceptor() {
        LocaleChangeInterceptor lci = new LocaleChangeInterceptor();
        lci.setParamName("lang");
        return lci;
    }

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(localeChangeInterceptor());
    }
}
```

## 9. テスト拡張

### 9.1 Web MVCテスト例

```java
@WebMvcTest(UserWebController.class)
@Import({UserServiceImpl.class, SecurityConfig.class})
class UserWebControllerTest {

    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private UserService userService;
    
    @Test
    @WithMockUser
    void listUsers_shouldReturnView() throws Exception {
        List<UserDto> users = Arrays.asList(
            new UserDto(1L, "user1@example.com", "User 1", LocalDateTime.now()),
            new UserDto(2L, "user2@example.com", "User 2", LocalDateTime.now())
        );
        
        given(userService.findAll(any(Pageable.class)))
            .willReturn(new PageImpl<>(users));
        
        mockMvc.perform(get("/web/users"))
            .andExpect(status().isOk())
            .andExpect(view().name("users/list"))
            .andExpect(model().attributeExists("users"))
            .andExpect(model().attributeExists("pageInfo"));
    }
    
    @Test
    void showCreateForm_shouldReturnView() throws Exception {
        mockMvc.perform(get("/web/users/create"))
            .andExpect(status().isOk())
            .andExpect(view().name("users/create"))
            .andExpect(model().attributeExists("userForm"));
    }
}
```

## 10. 注意事項

1. **JSPの制限事項**:
   - Spring BootではJSPの使用は推奨されていない（公式ドキュメント参照）
   - 組み込みTomcat/JettyでのJSP使用には制限あり
   - WARデプロイ時は問題ない

2. **推奨代替案**:
   ```markdown
   - Thymeleaf (推奨)
   - FreeMarker
   - Mustache
   ```

3. **JSP設定要件**:
   - `src/main/webapp` ディレクトリが必要
   - `application.properties`/`yml`にビュー設定が必要
   - 組み込みサーバー使用時は追加依存関係が必要

4. **パフォーマンスチューニング**:
   - JSPはコンパイルされるため初回アクセスが遅い
   - 開発時は`spring.jsp.init-parameters.development=true`設定を推奨
   - 本番環境ではプリコンパイルを検討

この設計書をベースに、プロジェクト要件に応じてJSP画面機能を実装してください。ただし、新規プロジェクトではThymeleafなどのテンプレートエンジンの使用を検討することを推奨します。