
---

# 🔧 データベースパフォーマンスチューニング
**データベースパフォーマンスチューニング**は、データベースそのものだけでなく、OS・ネットワーク・ストレージ・仮想化基盤・監視体制など、**全体のアーキテクチャと運用体制を俯瞰した最適化**が重要です。

---

## 🔧 1. ハードウェアおよび基盤レイヤのチューニング

### ✅ CPU

* **スレッド数やクロック数がボトルネックになっていないか確認**
  → クエリの並列処理やインデックス再構築などで重要。
* **ハイパースレッディング無効化の検討**（ワークロードにより逆効果の場合あり）

### ✅ メモリ

* **DBに割り当てるメモリサイズの見直し**

  * PostgreSQLなら `shared_buffers`、MySQLなら `innodb_buffer_pool_size`
* **OSキャッシュとDBキャッシュのバランス調整**

### ✅ ストレージ

* **IOPSとスループットの計測・確認**

  * ディスクのレイテンシ（<1msが理想）、待ち時間
* **NVMe SSDの導入**、RAID構成（RAID10推奨）などを検討
* **ファイルシステム最適化**

  * ext4 / XFS などのチューニング、mountオプション

---

## 🌐 2. ネットワーク構成の最適化

* **DBサーバーとアプリケーションの通信遅延の最小化**

  * ローカルネットワーク内配置、TCP Keepalive調整
* **スロークエリによるコネクション保持の影響を調査**
* **ネットワークバッファやMTUサイズの調整**

---

## 🛠 3. 仮想化・クラウド基盤のチューニング（特にIaaSの場合）

* **バースト型I/O制限の確認（例：AWSのT系インスタンス）**
* **ストレージのIO制限（EBSのIOPS/スループット制限）**
* **NUMAの影響の確認**（特にVMwareやKVMで仮想CPU割当が不均等な場合）

---

## 📊 4. データベースソフトウェア設定

### PostgreSQL / MySQL / Oracle などDBごとに違うが、共通観点：

* **バッファサイズ（キャッシュ）設定**
* **ワークメモリ、ソートバッファサイズ**
* **ログ設定（スロークエリ、実行計画）を有効化して原因特定**

---

## 🔎 5. 監視・ログ・可視化

* **メトリクス収集ツール導入**

  * Prometheus + Grafana、Datadog、CloudWatch など
* **スロークエリログの定期分析**

  * 実行時間が長いクエリと回数を分類して傾向分析
* **ディスクIO、メモリスワップ、CPU使用率の定常監視**

---

## 🧠 6. 接続・コネクション管理

* **Connection Pool の適切な設定**

  * pgBouncer（PostgreSQL）やProxySQL（MySQL）などの導入
  * Max Connectionsの制限とタイムアウト調整

---

## 🧪 7. テスト・ベンチマーク

* **sysbench / pgbench / HammerDBなどを用いた負荷テスト**
* **ピーク時間帯を再現し、ボトルネック分析**

---

## 📋 8. 運用設計・バックアップ・フェイルオーバー考慮

* **バックアップ実行時のI/O競合を避ける時間帯に設定**
* **レプリケーションのラグがパフォーマンスに与える影響の調査**
* **オートバキューム（PostgreSQL）などの影響も確認**

---

## 🧾 9. チューニングの基本フロー

1. **目的確認**（例：応答時間の改善、バッチ処理時間の短縮）
2. **現状調査（メトリクス＋ログ）**
3. **ボトルネック特定（CPU/IO/SQL/コネクション）**
4. **設定変更 or ハードウェア増強 or アーキテクチャ改善**
5. **再測定・効果検証**
6. **ドキュメント化と継続的監視**

---

## 📦 補足：クラウド特有のインフラ視点

* **スケールアップ vs スケールアウトの判断**
* **Aurora や Cloud SQL などのマネージドDBでの監視項目**
* **自動スナップショットやフェイルオーバーのパフォーマンス影響**

---

