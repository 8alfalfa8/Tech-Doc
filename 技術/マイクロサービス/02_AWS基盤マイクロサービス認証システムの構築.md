
---

# 🚀 AWS基盤マイクロサービス認証システムの構築

以下に、**AWS基盤でマイクロサービス向けの認証システムを構築する際の全体像・構成パターン・詳細設計項目・実装ポイント・セキュリティ考慮点**を体系的かつ充実に解説します。

---

## ✅ 1. 概要：AWS基盤マイクロサービス認証システムとは

**目的：**

* マイクロサービス間・外部との通信において**信頼性のある認証・認可機構**を提供する
* ユーザー・システム間の\*\*認証（Authentication）**と**認可（Authorization）\*\*を確実に制御する
* **拡張性・安全性・運用性**を備えた統合認証基盤をAWSで構築する

---

## ✅ 2. 主な構成要素（全体構成図）

```plaintext
+----------------------+     +------------------------+
|   クライアント端末     | --> | API Gateway            |
| (Web / SPA / モバイル) |    | (OAuthリダイレクト等)   |
+----------------------+     +------------------------+
                                      |
                                      v
                             +--------------------+
                             | Cognito / IAM / IdP|
                             |  - 認証 (OIDC, SAML)| 
                             |  - トークン発行     |
                             +--------------------+
                                      |
                                      v
                             +--------------------+
                             | Lambda or ECS ...  |
                             | (Token検証/処理)    |
                             +--------------------+
                                      |
                    +----------------+------------------+
                    |                |                  |
                    v                v                  v
           +--------------+  +---------------+  +------------------+
           | サービスA     |  | サービスB     |   | サービスC (DB等) |
           | (ECS/Fargate)|  | (EKS/Lambda)  |  |                  |
           +--------------+  +---------------+  +------------------+
```

---

## ✅ 3. 認証・認可のパターン

| 対象        | 方法            | 説明                            |
| --------- | ------------- | ----------------------------- |
| エンドユーザー   | OAuth2 + OIDC | Cognito, Googleなど外部IdP対応      |
| マイクロサービス間 | JWT + IAMロール  | Token署名検証 or STSで一時認証情報       |
| 管理者用コンソール | IAM + MFA     | IAM Identity CenterまたはCognito |

---

## ✅ 4. AWSサービス利用の設計ポイント

### ① Amazon Cognito

* **ユーザープール**：ユーザーID/パスワードの管理 + OIDC対応
* **外部IdP連携**：Google, Apple, Azure ADなどとOAuth/SAMLで連携可能
* **トークン**：Access Token (短命), ID Token (OIDC用), Refresh Token (長命)

### ② API Gateway

* OIDCトークンの**検証**機能あり
* **Cognitoオーソライザー**または**Lambdaオーソライザー**で細粒度の認可制御

### ③ Lambda（カスタム認証処理用）

* トークンの**署名検証**, クレームのチェック
* Role/Scopeに応じた**認可判定**
* 認証イベントログ（CloudWatch, X-Ray）

### ④ IAM + STS

* サーバー間のマイクロサービス通信では、IAM Roleを付与し、**署名付きリクエスト (SigV4)** や **一時トークン (STS)** による認証が推奨される

---

## ✅ 5. 認証フロー詳細（Cognito + OIDC）

### ① サインインフロー

1. ユーザーがSPAなどからログイン要求
2. Cognitoの認証ページへリダイレクト（ホストUIまたはカスタムUI）
3. 認証成功 → OIDCトークン発行（ID Token, Access Token, Refresh Token）
4. SPA側で**アクセストークンを保持し、API呼び出し時にAuthorizationヘッダーに付与**

### ② Tokenの検証フロー

* API Gateway / Lambdaがトークンを受け取り
* JWTの**署名を検証（公開鍵 via JWKS）**
* **exp（期限切れ）**, **aud（想定対象）**, **scope/role** をチェック
* 有効であれば、処理を継続

---

## ✅ 6. IAMベースのサービス間認証

### 利用シナリオ：

* ECS/EKS → S3
* Lambda → RDS
* ECSから別のECS（API）へ

### 方法：

* 各マイクロサービスに **IAMロール（タスクロール）** を割り当て
* 必要に応じて **AssumeRole + STS** で一時的に権限を借りる
* SigV4署名でAPIリクエストを実行

---

## ✅ 7. セキュリティ・運用観点の設計

| 項目           | 内容                                                   |
| ------------ | ---------------------------------------------------- |
| トークンの有効期限    | Access Token：5分〜1時間、Refresh Token：30日など              |
| トークンの保管      | クライアント側ではLocalStorageやCookieではなく **セキュアなセッションストレージ** |
| HTTPS強制      | API Gateway + ACMでTLS終端必須                            |
| ログ監査         | 認証ログ（Cognito） + Lambdaログ（CloudWatch Logs）            |
| セキュリティ自動チェック | AWS Config, GuardDuty, Access Analyzer               |
| IAMベストプラクティス | 最小権限の原則（Least Privilege） + 条件付きポリシー（IP制限など）          |

---

## ✅ 8. 拡張可能な実装例：認証ゲートウェイ構築

**目的：マイクロサービス手前に一元認証レイヤーを設ける**

| 構成要素          | 内容                         |
| ------------- | -------------------------- |
| API Gateway   | 複数サービスの共通入口（ドメインベースルーティング） |
| Cognito連携     | ユーザー向け認証制御、OIDC Token発行    |
| Lambdaオーソライザー | カスタムRole・Scope制御（RBAC対応）   |
| サービス間トークン     | IAM署名 or JWT HMAC/SHA256   |

---

## ✅ 9. TerraformやCDKでのIaC化の例（Cognito）

```hcl
resource "aws_cognito_user_pool" "main" {
  name = "example-pool"
}

resource "aws_cognito_user_pool_client" "web_app" {
  name         = "web-client"
  user_pool_id = aws_cognito_user_pool.main.id
  generate_secret = false
  allowed_oauth_flows = ["code"]
  callback_urls       = ["https://app.example.com/callback"]
  allowed_oauth_scopes = ["openid", "email", "profile"]
  supported_identity_providers = ["COGNITO"]
}
```

---

## ✅ AWSマイクロサービス環境における認証の全体像

以下にAWS上のマイクロサービス環境における**ユーザー認証、API Gatewayとサービスの認証、マイクロサービス間の認証**について、それぞれ役割・構成・方式・ベストプラクティスを体系的かつ詳細に説明します。

マイクロサービス環境では、次の**3層の認証**が必要です：

| 認証対象                    | 概要                            | 主な技術                          |
| ----------------------- | ----------------------------- | ----------------------------- |
| ① ユーザー認証                | クライアント（SPA, モバイル等）とバックエンドとの境界 | Cognito, OIDC, OAuth2.0, SAML |
| ② API Gatewayとマイクロサービス間 | フロントからのAPI呼び出しとバックエンド処理の境界    | JWT検証、IAMロール、Lambdaオーソライザー    |
| ③ マイクロサービス間通信           | サービスA → サービスB 等の内部通信          | IAM認証、SigV4署名、mTLS、サービスメッシュ   |

---

### ✅ ① ユーザー認証（エンドユーザー → API）

#### 💡 目的

* エンドユーザーの本人性を確認（Authentication）
* ユーザーの権限を明確化（Authorization）
* 安全にTokenを発行・利用し、アクセス制御を実現

#### 💡 一般構成

```plaintext
[ユーザー]
   ↓ OAuth2.0 + OIDC
[Amazon Cognito / 外部IdP (Google等)]
   ↓ ID / Access Token
[API Gateway or ALB]
```

#### 🔧 技術・構成詳細

| 要素             | 内容                                                                         |
| -------------- | -------------------------------------------------------------------------- |
| Amazon Cognito | - ユーザープール（ID管理、MFA）<br> - OIDC準拠のID/Access/Refreshトークン発行                   |
| 外部IdP連携        | - Google, Azure AD, AppleなどとOAuth/SAML連携                                   |
| トークン方式         | - JWT (JSON Web Token)<br> - ID Token（ユーザー属性）<br> - Access Token（APIアクセス用） |
| API保護          | - API GatewayにCognitoオーソライザーを連携<br> - またはALBでCognitoと統合しOIDC検証             |

#### 🛡️ セキュリティ対策

* HTTPS強制、トークン期限制御（短命＋Refresh Token運用）
* XSRF対策（SPAの場合はSameSite Cookie + セッションストレージ）
* クレーム（claim）による権限制御（例：role, scope）

---

### ✅ ② API Gatewayとマイクロサービスの認証

#### 💡 目的

* 外部からのリクエストをAPI Gatewayが受け取り、正当性を判断
* 各バックエンドサービスに安全にリクエストを転送

#### 💡 一般構成

```plaintext
[Client]
  ↓ Authorization: Bearer <JWT>
[API Gateway]
  ↓ Lambda or VPC Link
[Backend (Lambda, ECS, EKS, etc.)]
```

#### 🔧 技術選択肢と構成例

| 手法              | 説明                     | 利点                    | 注意点                    |
| --------------- | ---------------------- | --------------------- | ---------------------- |
| Cognitoオーソライザー  | OIDC準拠トークンを検証          | シンプル、高速               | Role/Scopeによる細粒度認可は難しい |
| Lambdaオーソライザー   | 独自ロジック（DB参照など）で認可      | 柔軟、RBAC可能             | Cold Start問題           |
| JWT検証をバックエンドで行う | 各サービスが自前でトークン検証        | 非同期トークン再検証や署名ロジック追加可能 | 実装・保守がやや複雑             |
| IAM認証 (SigV4)   | IAMユーザー/ロールによる署名付きアクセス | 高セキュリティ、マネージド         | SPAなどのパブリッククライアントには不向き |

#### 🛡️ ベストプラクティス

* トークンを短命にし、必要に応じてRefresh
* API Gatewayでのロギング有効化（CloudWatch）
* 権限チェック（Role, Scope, tenant ID など）をLambdaまたはバックエンドで追加

---

### ✅ ③ マイクロサービス間の認証（Service-to-Service）

#### 💡 目的

* 各サービスが自身を証明し、必要最小限のアクセス権で通信
* API呼び出しやデータアクセスの際の信頼を確保

#### 💡 一般構成

```plaintext
[Service A (ECS/EKS/Lambda)]
  ↓ 呼び出し（署名付きリクエスト or JWT）
[Service B (ECS/EKS/Lambda)]
```

#### 🔧 主な方式

| 方法                     | 説明                                      | 主な用途                            |
| ---------------------- | --------------------------------------- | ------------------------------- |
| IAMロール + SigV4署名       | AWSサービス間の標準。各サービスにIAMロール付与し、認証付きAPI呼び出し | ECS → S3 / Lambda → DynamoDB など |
| AssumeRole + STS       | 他サービスのロールを一時的に引き受ける。信頼ポリシー制御が可能         | 複数アカウント連携、クロスサービス制御             |
| JWT + サービス専用秘密鍵        | 各サービスがJWTを発行・検証し、通信先で署名検証               | 非AWSサービスやZero Trust構成向け         |
| mTLS（相互TLS）            | サービスメッシュ環境での通信暗号化＋認証（証明書ベース）            | EKS + Istio/Envoyなど             |
| OPA（Open Policy Agent） | 認可判断をサービス外に委譲（Regoポリシー）                 | RBAC/ABACや属性ベース制御を行う場合          |

---

### ✅ サンプル構成例（IAM＋Cognito統合パターン）

```plaintext
[User (SPA)]
 ↓ Login
[Cognito → JWT発行]
 ↓ Authorization: Bearer <Access Token>
[API Gateway（Cognitoオーソライザー）]
 ↓
[Service A（Lambda）]
 ↓ IAMロール + SigV4
[Service B（ECS, EKS）]
```

---

### ✅ 監査・セキュリティ設計補足

| 項目       | 対応策                                                       |
| -------- | --------------------------------------------------------- |
| 認証ログ     | CloudTrail, CloudWatch Logs（API Gateway, Cognito, Lambda） |
| トークン不正使用 | トークンの署名アルゴリズム（RS256） + 期限管理（exp）                          |
| アクセス制御   | IAM Policy + 条件付きアクセス（IP制限、時間帯、MFA）                       |
| 自動化      | Terraform / CDK によるロール・ポリシー・Cognito自動設定                   |
| ゼロトラスト対策 | mTLS + Identity Propagation（JWT、SPIFFE）をEKSなどで併用          |

---

### ✅ 最後に：設計ガイドラインまとめ

| 観点        | ガイドライン                                  |
| --------- | --------------------------------------- |
| 統一トークン形式  | JWT（OIDC準拠）で統一し、RSA署名を使う                |
| 認証ロジックの分離 | 認証はGatewayや専用サービスに任せ、業務ロジックから分離         |
| 最小権限の原則   | IAMポリシー、トークンスコープを厳格に設計                  |
| 統合監査基盤    | CloudTrail + GuardDuty + SecurityHubを活用 |
| 開発・運用の分離  | ステージング/本番環境ごとの認証基盤分離（Terraform活用）       |

---

## ✅ マイクロサービス側の認証最小化
「**共通認証基盤によって各マイクロサービス側では認証を考慮しなくてよい構成**」は、**正しく設計すれば実現可能です**。ただし、完全に“ゼロ考慮”というよりは、「**認証責任を共通ゲートウェイでカプセル化**し、マイクロサービスでは**認可のみ最小限の考慮**に留める」ことが現実的な設計方針です。

以下にそのための**アーキテクチャ構成、考慮点、実装方式**を詳しく説明します。

---

### ✅ 目指す構成の要点

| 項目     | 要件                                                    |
| ------ | ----------------------------------------------------- |
| 共通認証   | ユーザー認証をAPI Gatewayやサービスメッシュの入口で完結させる（例：Cognito、JWT検証） |
| トークン中継 | 認証済みトークン（JWT）をAPI Gatewayが検証し、有効なものだけマイクロサービスに中継      |
| サービス側  | 認証済み前提で受け取り、追加の認証チェックは不要（もしくは軽微な認可処理）                 |

---

### ✅ 推奨構成アーキテクチャ（共通認証カプセル化）

```
 [ クライアント ]
      │
      ▼
+-------------------------+
| API Gateway (認証)      |
| - Cognitoオーソライザー  |
| - JWT検証               |
+-------------------------+
      │（認証済リクエスト＋JWT）
      ▼
+----------------------------+
| 各マイクロサービス群         |
| - 認証不要（信頼済トークン） |
| - 必要に応じて認可処理       |
+----------------------------+
```

---

### ✅ 実現するための構成要素と設計ポイント

#### ① **API Gateway + Cognitoオーソライザー**

* ユーザーがログインし、Cognitoから**JWTトークンを取得**
* API GatewayはCognitoと連携し、**JWTトークンの検証**を実施
* 正常なら、JWTを**リクエストヘッダに添付**し、マイクロサービスへ中継

#### ② **API Gatewayでの認証責任の完結**

* JWTの期限、署名検証、スコープ・audienceチェックなどをここで済ませる
* 不正トークン・失効トークンなどは**マイクロサービスに到達する前に拒否**
* → **各マイクロサービスは「認証済の安全なユーザー」として処理開始可能**

#### ③ **各マイクロサービスの最小構成**

* トークンを再検証せず、ヘッダから必要なClaimだけ抽出（例：`user_id`, `role`）
* 必要であれば**RBAC/ABAC**の軽量認可を追加
* それ以上の**ユーザー認証処理は一切不要**

---

### ✅ オプション：サービスメッシュとmTLSによる“ゼロトラスト対応”

* サービス間通信にも認証を入れたい場合：

  * **App MeshやIstio on EKS**で**mTLS**による通信元認証
  * 各マイクロサービスは**証明書付きトラフィックのみを受信**
  * JWTベースの共通トークンを「サービス間通信用」に使ってもOK（例：Client Credentials Flow）

---

### ✅ 補足：Lambda関数を共通Proxyとする案（認証抽象化）

```
[Client]
   │
   ▼
[API Gateway] ──→ [共通Auth Proxy Lambda] ──→ [Microservice]
                         │
                         └─ JWT 検証・Claim抽出・付与
```

* すべてのAPIリクエストは「共通Proxy Lambda」を経由
* Proxyが**JWTの妥当性を完全検証**し、結果（ユーザー情報）を安全に伝達
* 各マイクロサービスでは**署名や期限など考慮不要**

---

### ✅ 実現時の注意点

| 項目         | 内容                                                      |
| ---------- | ------------------------------------------------------- |
| Claimの内容設計 | `sub`, `role`, `scope`, `tenant_id` などを明示的に含める          |
| トークン改ざん対策  | JWTの署名検証は必ずGateway or Proxyで済ませる                        |
| フォワーディング   | トークンは `Authorization: Bearer xxx` または `X-User-*` ヘッダで渡す |
| 内部API制御    | 外部アクセス不可のVPC内マイクロサービス構成（private subnet）                 |

---

### ✅ まとめ：理想的な共通認証構成

| 要素             | 対応方式                                   |
| -------------- | -------------------------------------- |
| 認証の共通化         | API Gateway + Cognito or Lambdaオーソライザー |
| マイクロサービスでの認証責任 | 不要（Gatewayで完結）                         |
| マイクロサービスでの認可   | 必要に応じて軽量実装（role/scopeによる処理分岐）          |
| サービス間通信の認証     | IAMロール or JWT + mTLS                   |

---

# ✅ 構築のステップ

以下に、**AWSマイクロサービス認証基盤構築の5ステップ**について、**各ステップの詳細タスク・作業期間目安・作業内容・成果物**を体系的に整理してご説明します。

* ① 要件定義
* ② 設計
* ③ 実装
* ④ セキュリティ
* ⑤ 運用

---

## ✅ ステップ①：要件定義

| 項目         | 内容                                    |
| ---------- | ------------------------------------- |
| **目的**     | 認証・認可の基本要件やシステム構成を整理し、以降の設計・実装の前提を固める |
| **作業期間目安** | 3〜5営業日                                |
| **主な作業**   |                                       |

* SSOの要否（社内AD, Azure AD, Google Workspace などとの連携要件）
* 認証対象の整理（ユーザー／管理者／サービス間通信など）
* 認証スコープの定義（APIごと、リソースごと、マイクロサービス単位）
* 外部IdP（OIDC/SAML）との接続方式の確認
* クライアント（SPA、ネイティブアプリ、バッチ）ごとの認証方式検討
* マイクロサービス群の一覧とAPIインターフェース確認

\| **成果物** |

* 認証要件定義書（SSO要否、トークン種別、接続IdP一覧など）
* API一覧表（エンドポイント、必要なスコープ、アクセス元）
* サービス一覧＋構成図（draw\.io）

---

## ✅ ステップ②：設計

| 項目         | 内容                                  |
| ---------- | ----------------------------------- |
| **目的**     | 要件に基づき、認証・認可方式の設計を行い、安全かつ拡張可能な基盤を定義 |
| **作業期間目安** | 5〜7営業日                              |
| **主な作業**   |                                     |

* Cognitoの構成設計（ユーザープール／ドメイン／属性など）
* トークンの設計（ID/Access/Refreshトークン、claim設計、RSA署名）
* 認可方式設計（RBAC/ABAC、スコープ、ロール定義）
* IAMロール・ポリシー設計（サービス間呼び出し、リソースアクセス）
* API Gatewayのオーソライザー方式決定（Cognito/Lambda/JWT検証）
* トークン失効戦略、再認証フローの設計
* ログ・監査要件の取り込み（CloudTrail, GuardDuty, AccessLog）

\| **成果物** |

* 認証アーキテクチャ設計書
* トークン設計仕様書（claim一覧、有効期限、署名方式）
* IAM設計書（ロール・信頼関係・アクション範囲）
* API Gateway設計（エンドポイント、メソッド保護方式）

---

## ✅ ステップ③：実装

| 項目         | 内容                                            |
| ---------- | --------------------------------------------- |
| **目的**     | 設計に基づき、認証基盤の具体構築（Cognito/ApiGW/Lambda/IAM）を行う |
| **作業期間目安** | 7〜10営業日                                       |
| **主な作業**   |                                               |

* Cognitoユーザープール・アプリクライアント・カスタム属性設定
* 外部IdPとのOIDC/SAML連携設定（メタデータXML、証明書連携）
* API Gateway構築と認可方式設定（オーソライザー、IAMポリシー）
* Lambda関数でのトークン検証ロジック実装（jwtライブラリ等利用）
* IAMロールと信頼ポリシーの作成、Lambda/ECS/EKSへの付与
* Terraform/CDKでのIaC化（再現性と運用性確保）
* 簡易管理画面やcurlテストによる認証シナリオ検証

\| **成果物** |

* CloudFormation/Terraformコード（Cognito/ApiGW/Lambda/IAM等）
* Lambda認証関数コード（例：Node.js + jose / Python + PyJWT）
* テストレポート（各認証フローの通過ログ、異常時対応ログ）

---

## ✅ ステップ④：セキュリティ

| 項目         | 内容                                |
| ---------- | --------------------------------- |
| **目的**     | 認証基盤に必要なセキュリティ機構を整備し、脅威に対する対策を講じる |
| **作業期間目安** | 3〜5営業日                            |
| **主な作業**   |                                   |

* トークンのRSA署名確認、署名鍵のキーローテーション設計（KMS）
* Cognito + ACM によるHTTPS通信強制設定
* トークンの有効期限（exp）とリフレッシュトークンのTTL設計
* API GatewayのWAF設定、リクエストレート制限
* サービス間通信のIAMポリシーを最小権限に調整
* CloudTrail, GuardDuty, AWS Config の有効化と通知設定
* ALB/API Gatewayのアクセスログ出力と保存（S3, CloudWatch）

\| **成果物** |

* セキュリティ設計書（暗号化、署名、監査ログポリシー）
* WAF設定ファイル、GuardDutyアラートルール定義
* KMSキー定義とトークン有効期限ポリシー

---

## ✅ ステップ⑤：運用

| 項目         | 内容                             |
| ---------- | ------------------------------ |
| **目的**     | 認証基盤の安定運用、セキュリティ維持、障害早期発見体制の確立 |
| **作業期間目安** | 初期設定2〜3日、以後継続運用                |
| **主な作業**   |                                |

* CloudWatch Logsによるトークンエラー/異常検知設定
* Lambda・Cognito・API Gatewayログのローテーションと保存管理（S3）
* トークンの異常使用検出（GuardDutyの異常検知アラート）
* IAMアクセスアナライザーによるポリシー誤設定の検出
* AWS Configルールによるポリシー準拠違反の自動通知
* トークン署名鍵やパスワードの自動ローテーション設計（Secrets Manager, KMS）

\| **成果物** |

* 運用マニュアル（ログ監視、診断、定期チェック項目）
* CloudWatchダッシュボード（認証リクエスト数、エラー数、JWT検証失敗数）
* 通知設計（SNS + Slack連携）

---

## ✅ まとめ表（全体一覧）

| ステップ     | 作業名    | 作業期間      | 主な作業                            | 成果物                |
| -------- | ------ | --------- | ------------------------------- | ------------------ |
| ① 要件定義   | 認証方針整理 | 3〜5日      | SSO要否、IdP、API構成                 | 認証要件書、構成図          |
| ② 設計     | 認証設計   | 5〜7日      | トークン方式、IAM設計、オーソライザー方針          | 設計書、IAM定義          |
| ③ 実装     | 基盤構築   | 7〜10日     | Cognito/API GW/Lambda/IAM設定     | コード類、認証関数、テストレポート  |
| ④ セキュリティ | 対策実装   | 3〜5日      | トークン署名、WAF、KMS、監査ログ             | セキュリティ設計書、設定       |
| ⑤ 運用     | 継続監視   | 初期2〜3日＋継続 | CloudWatch, Config, SecurityHub | 運用手順書、通知設定、ダッシュボード |

---
