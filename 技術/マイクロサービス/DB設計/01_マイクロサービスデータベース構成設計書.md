# マイクロサービスデータベース構成設計書

## 1. 概要

### 1.1. 目的
本設計書は、マイクロサービスアーキテクチャにおけるデータベースの構成方針、設計原則、および実装方式を定義することを目的とする。

### 1.2. 適用範囲
- 全マイクロサービスおよび関連データベース
- データ永続化層の設計と実装
- データ連携および整合性保証メカニズム

## 2. 設計原則

### 2.1. 基本方針
- **データベース・パー・サービス**: 各マイクロサービスが独自のデータベースを保有
- **サービス自律性**: サービス間の直接的なデータベース共有を禁止
- **API駆動連携**: サービス間データ連携はAPI経由でのみ実施
- **適切なデータベース技術の選択**: 用途に応じた最適なデータベース技術の採用

## 3. データベース構成

### 3.1. データベースタイプ別構成

| サービス名 | データベースタイプ | バージョン | 用途 | データ規模見積り |
|------------|-------------------|------------|------|------------------|
| ユーザーサービス | PostgreSQL | 14.x | トランザクションデータ | 10GB/年 |
| 注文サービス | PostgreSQL | 14.x | トランザクションデータ | 50GB/年 |
| 商品カタログサービス | MongoDB | 5.x | ドキュメントデータ | 5GB/年 |
| 分析サービス | Amazon Redshift | - | 分析データ | 1TB/年 |
| キャッシュサービス | Redis | 6.x | セッション/キャッシュ | メモリ内 |
| 検索サービス | Elasticsearch | 7.x | 全文検索 | 20GB/年 |

### 3.2. 接続設定

```yaml
# データベース接続設定例
database:
  host: ${DB_HOST}
  port: ${DB_PORT}
  name: ${DB_NAME}
  username: ${DB_USER}
  password: ${DB_PASSWORD}
  pool:
    max: 20
    min: 5
    acquire: 30000
    idle: 10000
  dialect: postgres
  ssl: require
```

## 4. データモデル設計

### 4.1. サービス別データモデル

**ユーザーサービス（PostgreSQL）**
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT true
);

CREATE TABLE user_profiles (
    user_id UUID PRIMARY KEY REFERENCES users(id),
    avatar_url VARCHAR(500),
    preferences JSONB,
    last_login TIMESTAMP WITH TIME ZONE
);
```

**注文サービス（PostgreSQL）**
```sql
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL, -- 参照のみ、外部キー制約は設定しない
    total_amount DECIMAL(10,2) NOT NULL,
    status VARCHAR(50) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE order_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID REFERENCES orders(id),
    product_id UUID NOT NULL, -- 商品サービス参照
    quantity INTEGER NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL
);
```

## 5. データ整合性戦略

### 5.1. 分散トランザクション管理
- **Sagaパターンの採用**: 長時間トランザクションを一連のローカルトランザクションに分解
- **補償トランザクション**: 失敗時のロールバック処理を実装

### 5.2. イベント駆動アーキテクチャ
- **変更データキャプチャ（CDC）**: データベース変更のイベント発行
- **イベントソーシング**: 重要な状態変化のイベント記録

## 6. データレプリケーションと同期

### 6.1. クロスサービスデータ参照
- **API呼び出し**: リアルタイムデータ参照
- **データレプリカ**: 読み取り専用データの非同期複製
- **マテリアライズドビュー**: 集計データの事前計算

### 6.2. データ同期方式
```mermaid
graph TD
    A[ソースデータベース] -->|CDC| B[メッセージブローカー<br/>Kafka]
    B --> C[コネクター<br/>Debezium]
    C --> D[ターゲットデータベース<br/>読み取り専用レプリカ]
```

## 7. バックアップとリカバリ

### 7.1. バックアップ戦略
- **自動スナップショット**: 日次スナップショット（7日間保持）
- **トランザクションログ**: 15分間隔の継続的アーカイブ
- **地理的冗長化**: 別リージョンへの複製

### 7.2. リカバリ目標
- **RPO（目標復旧時点）**: 最大15分
- **RTO（目標復旧時間）**: 2時間以内

## 8. セキュリティ対策

### 8.1. データ保護
- **暗号化**: 転送中（TLS 1.3）および保存中（AES-256）の暗号化
- **マスキング**: 非生産環境での個人情報マスキング
- **アクセス制御**: ロールベースアクセス制御（RBAC）

### 8.2. 監査と監視
- **監査ログ**: 全てのデータアクセス操作の記録
- **異常検知**: 不審なアクセスパターンの検出
- **コンプライアンス**: GDPR、PCI DSS対応

## 9. 監視とパフォーマンス

### 9.1. 監視指標
- データベース接続数
- クエリ応答時間
- トランザクション率
- レプリケーションラグ

### 9.2. パフォーマンス最適化
- インデックス設計
- クエリ最適化
- 接続プーリング
- 読み取りレプリカの活用

## 10. デプロイメントとマイグレーション

### 10.1. データベース変更管理
- **バージョン管理**: 全てのスキーマ変更のバージョン管理
- **移行スクリプト**: 自動化されたデータベース移行（Flyway/Liquibase）
- **ブルーグリーンデプロイ**: ダウンタイムゼロでのスキーマ変更

### 10.2. 環境構成
| 環境 | インスタンスサイズ | レプリカ数 | バックアップ保持期間 |
|------|-------------------|------------|---------------------|
| 開発 | t3.medium | 1 | 3日 |
| ステージング | r5.large | 2 | 7日 |
| 本番 | r5.4xlarge | 3+ | 35日 |

## 11. 今後の拡張性

### 11.1. スケーリング戦略
- **水平スケーリング**: シャーディングによるデータ分散
- **読み取りスケーリング**: レプリカの追加
- **機能別分割**: データベースの機能別分離

### 11.2. 技術的負債管理
- 定期的なパフォーマンスレビュー
- 未使用インデックスの削除
- データアーカイブ戦略の実施

---
**承認者**:
- システムアーキテクト: ____________________
- データベース管理者: ____________________
- セキュリティ責任者: ____________________

**最終更新日**: 2024年3月15日

**バージョン**: 1.0
